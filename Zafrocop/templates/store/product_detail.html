{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<section class="section-content padding-y bg">
  <div class="container">
    <div class="card p-4" style="border: none; margin-top: 0px; margin-bottom: 40px;">
      <div class="d-flex flex-wrap" style="gap: 3rem;">

        <!-- Product Image Section -->
        <div style="flex: 1; min-width: 300px; max-width: 450px; position: relative;">
          <img id="mainImage" src="{{ single_product.images.url }}" alt="{{ single_product.product_name }}"
            style="width: 100%; max-height: 420px; border-radius: 10px; object-fit: contain; background: #f8f8f8; padding: 10px;">

          <!-- Thumbnails -->
          <div id="thumbnailContainer" style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
            <img src="{{ single_product.images.url }}" onclick="switchImage(this.src)" style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 6px; border: 2px solid #ccc;">
            {% for img in product_gallery %}
              <img src="{{ img.image.url }}" onclick="switchImage(this.src)" style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 6px; border: 2px solid #ccc;">
            {% endfor %}
          </div>
        </div>

        <!-- Product Info Section -->
        <div style="flex: 1; min-width: 300px;">
          <h2>{{ single_product.product_name }}</h2>
          <h5 class="mb-0" style="color: #B87333;">â‚¹ {{ single_product.price }}</h5>
          <p class="mt-3">{{ single_product.description }}</p>

          {% if highlights %}
            <h5 class="mt-4">Benefits</h5>
            <ul style="list-style-type: disc; padding-left: 20px;">
              {% for item in highlights %}
                <li>{{ item }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          <form action="{% url 'add_cart' single_product.id %}" method="POST" class="mt-4">
            {% csrf_token %}

            <!-- Action Buttons -->
            {% if single_product.stock > 0 %}
              <div class="d-flex flex-wrap" style="gap: 20px;">
                <button type="submit" class="btn text-white px-4" style="background-color: #B87333;">
                  <i class="fas fa-shopping-cart text-white"></i> Add to Cart
                </button>
                {% if in_wishlist %}
                  <a href="{% url 'remove_from_wishlist' single_product.id %}" class="btn text-white px-4" style="background-color: #B87333;">
                    <i class="fas fa-heart-broken"></i> Remove from Wishlist
                  </a>
                {% else %}
                  <a href="{% url 'add_to_wishlist' single_product.id %}" class="btn text-white px-4" style="background-color: #B87333;">
                    <i class="fas fa-heart text-white"></i> Add to Wishlist
                  </a>
                {% endif %}
              </div>
            {% else %}
              <h5 class="text-danger mt-3">Out of Stock</h5>
            {% endif %}
          </form>
        </div>
      </div>

      <!-- Review Form -->
      <div class="mt-5">
        <form action="{% url 'submit_review' single_product.id %}" method="POST">
          {% csrf_token %}
          <h5>Write Your Review</h5>
          <label>Rate this product:</label><br>
          <div class="rate mb-2">
            {% for value in "54321" %}
              <input type="radio" id="star{{ value }}" name="rating" value="{{ value }}" required />
              <label for="star{{ value }}" title="{{ value }} stars"></label>
            {% endfor %}
          </div>

          <textarea name="review" rows="4" class="form-control mb-3" placeholder="Your review..."></textarea>

          {% if user.is_authenticated %}
            {% if orderproduct %}
              <button type="submit" class="btn btn-primary">Submit Review</button>
            {% else %}
              <p class="text-muted">You must purchase the product to post a review.</p>
            {% endif %}
          {% else %}
            <p class="text-muted">You must be logged in to post a review. <a href="{% url 'login' %}">Login</a></p>
          {% endif %}

          {% include 'includes/alerts.html' %}
        </form>
      </div>

      <!-- Display Reviews -->
      <div class="mt-4">
        <h4>Customer Reviews</h4>
        {% for review in reviews %}
          <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between">
              <strong>{{ review.user.full_name }}</strong>
              <small class="text-muted">{{ review.updated_at }}</small>
            </div>
            <div class="rating-star text-warning">
              {% for i in 1|make_range:5 %}
                <i class="fa fa-star{% if review.rating < i %}-o{% endif %}"></i>
              {% endfor %}
            </div>
            <p class="mt-2">{{ review.review }}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<!-- Image Gallery Script -->
<script>
  let currentIndex = 0;

  function changeImage(direction) {
    currentIndex += direction;
    if (currentIndex < 0) currentIndex = imageList.length - 1;
    if (currentIndex >= imageList.length) currentIndex = 0;
    document.getElementById('mainImage').src = imageList[currentIndex];
  }

  function switchImage(src) {
    document.getElementById('mainImage').src = src;
    currentIndex = imageList.indexOf(src);
  }

  function updateQty(change) {
    const qtyInput = document.getElementById("quantityInput");
    let currentQty = parseInt(qtyInput.value);
    if (!isNaN(currentQty)) {
      qtyInput.value = Math.max(1, currentQty + change);
    }
  }
</script>
{% endblock %}
